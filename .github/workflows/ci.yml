name: CI

on:
  pull_request:
  push:
    branches:
      - main
      - develop

jobs:
  # TypeScript Type Checking
  typecheck:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json
      
      - name: Install root dependencies
        run: npm install
      
      - name: Type check backend
        working-directory: ./backend
        run: |
          npm install
          npx tsc --noEmit
      
      - name: Type check frontend
        working-directory: ./frontend
        run: |
          npm install
          npx tsc --noEmit

  # Backend CI
  backend:
    name: Backend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for Jest changed files detection
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install root dependencies
        run: npm install --prefix ..
      
      - name: Install backend dependencies
        run: npm ci
      
      - name: Lint backend
        run: npm run lint
      
      - name: Type check backend
        run: npx tsc --noEmit
      
      - name: Test backend
        run: npm run test
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:test@localhost:5432/test
      
      - name: Build backend
        run: npm run build
      
      - name: Security audit
        run: |
          npm audit --json > npm_audit.json || true
          npm audit --audit-level=high
        continue-on-error: false
      
      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-npm-audit
          path: backend/npm_audit.json
          retention-days: 30
      
      - name: Secret scanning
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          config-path: .gitleaks.toml
          exit-code: 1
          no-banner: false
          verbose: true

  # Frontend CI
  frontend:
    name: Frontend CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install root dependencies
        run: npm install --prefix ..
      
      - name: Install frontend dependencies
        run: npm ci
      
      - name: Lint frontend
        run: npm run lint
      
      - name: Type check frontend
        run: npx tsc --noEmit
      
      - name: Test frontend
        run: npm run test
      
      - name: Build frontend
        run: npm run build
      
      - name: Security audit
        run: |
          npm audit --json > npm_audit.json || true
          npm audit --audit-level=high
        continue-on-error: false
      
      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-npm-audit
          path: frontend/npm_audit.json
          retention-days: 30
      
      - name: Secret scanning
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          config-path: .gitleaks.toml
          exit-code: 1
          no-banner: false
          verbose: true

  # Generate API Types
  generate-api-types:
    name: Generate API Types
    runs-on: ubuntu-latest
    needs: [backend]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Generate API types
        run: npm run generate:api-types
      
      - name: Check for changes
        run: |
          if [ -n "$(git status --porcelain frontend/src/lib/api-types.ts)" ]; then
            echo "API types have changed. Please run 'npm run generate:api-types' locally and commit the changes."
            exit 1
          fi
